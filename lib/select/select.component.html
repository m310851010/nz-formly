<nz-select
  #instance
  [formControl]="$any(formControl)"
  [formlyAttributes]="field"
  [compareWith]="to.compareWith"
  [nzShowSearch]="to.nzShowSearch"
  [nzAllowClear]="to.nzAllowClear"
  [nzPlaceHolder]="to.nzPlaceHolder || to.placeholder"
  [nzOpen]="to.nzOpen"
  [nzAutoFocus]="to.nzAutoFocus"
  [nzDisabled]="to.disabled != null ? to.disabled! : formControl?.disabled!"
  [nzDropdownClassName]="to.nzDropdownClassName"
  [nzDropdownMatchSelectWidth]="to.nzDropdownMatchSelectWidth"
  [nzDropdownStyle]="to.nzDropdownStyle"
  [nzServerSearch]="to.nzServerSearch"
  [nzFilterOption]="to.nzFilterOption"
  [nzMaxMultipleCount]="to.nzMaxMultipleCount"
  [nzMode]="to.nzMode"
  [nzNotFoundContent]="nzNotFoundContent"
  [nzSize]="to.nzSize"
  [nzAutoClearSearchValue]="to.nzAutoClearSearchValue"
  [nzBackdrop]="to.nzBackdrop"
  [nzBorderless]="to.nzBorderless"
  [nzShowArrow]="to.nzShowArrow"
  [nzCustomTemplate]="nzCustomTemplate"
  [nzSuffixIcon]="nzSuffixIcon"
  [nzRemoveIcon]="nzRemoveIcon"
  [nzClearIcon]="nzClearIcon"
  [nzMenuItemSelectedIcon]="nzMenuItemSelectedIcon"
  [nzTokenSeparators]="to.nzTokenSeparators"
  [nzLoading]="to.nzLoading"
  [nzMaxTagCount]="to.nzMaxTagCount"
  [nzMaxTagPlaceholder]="nzMaxTagPlaceholder"
  [nzOptionHeightPx]="to.nzOptionHeightPx"
  [nzOptionOverflowSize]="to.nzOptionOverflowSize"
  (nzOpenChange)="to.nzOpenChange && to.nzOpenChange($event, field, instance)"
  (nzScrollToBottom)="to.nzScrollToBottom && to.nzScrollToBottom($event, field, instance)"
  (nzOnSearch)="to.nzOnSearch && to.nzOnSearch($event, field, instance)"
  (nzFocus)="to.nzFocus && to.nzFocus($event, field, instance)"
  (nzBlur)="to.nzBlur && to.nzBlur($event, field, instance)"
  ngDefaultControl
>
  <ng-container *ngFor="let item of to.options | toAsync: $any(to) | async | defaultify: []">
    <ng-container *ngIf="item.hide !== false">
      <nz-option-group *ngIf="item.group; else simpleTemplate" [nzLabel]="item.label">
        <ng-container *ngFor="let child of item.group">
          <nz-option
            *ngIf="child.hide !== false"
            [nzValue]="child.value"
            [nzDisabled]="child.disabled"
            [nzLabel]="child.label"
            [nzCustomContent]="child.nzCustomContent"
          >
            <ng-container *nzStringTemplateOutlet="labelTemplate; context: { $implicit: item, field: field }">
              <span>{{ labelTemplate }}</span>
            </ng-container>
          </nz-option>
        </ng-container>
      </nz-option-group>

      <ng-template #simpleTemplate>
        <nz-option
          [nzValue]="item.value"
          [nzDisabled]="item.disabled"
          [nzLabel]="item.label"
          [nzHide]="item.hide"
          [nzCustomContent]="item.nzCustomContent"
        >
          <ng-container *nzStringTemplateOutlet="labelTemplate; context: { $implicit: item, field: field }">
            <span>{{ labelTemplate }}</span>
          </ng-container>
        </nz-option>
      </ng-template>
    </ng-container>
  </ng-container>
</nz-select>
